<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>WhatsApp Integration Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            .container {
                background: #f5f5f5;
                padding: 20px;
                border-radius: 8px;
                margin: 10px 0;
            }
            .result {
                background: #e8f5e8;
                padding: 15px;
                border-radius: 5px;
                margin: 10px 0;
            }
            .error {
                background: #ffe8e8;
                padding: 15px;
                border-radius: 5px;
                margin: 10px 0;
            }
            button {
                background: #007bff;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            }
            button:hover {
                background: #0056b3;
            }
            textarea {
                width: 100%;
                height: 100px;
                margin: 10px 0;
            }
            input[type="file"] {
                margin: 10px 0;
            }
        </style>
    </head>
    <body>
        <h1>ðŸ¤– AI Cruel - WhatsApp Integration Test</h1>

        <div class="container">
            <h2>ðŸ“± Parse Single Message</h2>
            <textarea
                id="messageInput"
                placeholder="Enter a message like: 'Don't forget the math assignment is due tomorrow at 11:59 PM'"
            >
Don't forget the physics assignment is due tomorrow at 11:59 PM</textarea
            >
            <br />
            <button onclick="parseMessage()">Parse Message</button>
            <div id="messageResult"></div>
        </div>

        <div class="container">
            <h2>ðŸ“„ Upload WhatsApp Chat File</h2>
            <input type="file" id="fileInput" accept=".txt" />
            <br />
            <button onclick="uploadFile()">Upload & Parse Chat</button>
            <div id="fileResult"></div>
        </div>

        <div class="container">
            <h2>ðŸ’¡ Examples</h2>
            <button onclick="loadExamples()">Load Examples</button>
            <div id="examplesResult"></div>
        </div>

        <script>
            const API_BASE = "http://localhost:8000";

            async function parseMessage() {
                const message = document.getElementById("messageInput").value;
                const resultDiv = document.getElementById("messageResult");

                if (!message.trim()) {
                    resultDiv.innerHTML = '<div class="error">Please enter a message</div>';
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append("message", message);
                    formData.append("sender", "Test User");
                    formData.append("auto_create", "false");

                    const response = await fetch(`${API_BASE}/api/whatsapp/parse-message`, {
                        method: "POST",
                        body: formData,
                    });

                    const data = await response.json();

                    if (response.ok) {
                        let html = '<div class="result">';
                        html += `<h3>âœ… Extracted ${data.extracted_deadlines.length} deadline(s)</h3>`;

                        data.extracted_deadlines.forEach((deadline) => {
                            html += `
                            <div style="border-left: 4px solid #007bff; padding-left: 15px; margin: 10px 0;">
                                <strong>ðŸ“… ${deadline.title}</strong><br>
                                Due: ${new Date(deadline.due_date).toLocaleString()}<br>
                                Priority: ${deadline.priority}<br>
                                Confidence: ${(deadline.confidence * 100).toFixed(0)}%
                            </div>
                        `;
                        });
                        html += "</div>";
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `<div class="error">Error: ${
                            data.detail || "Unknown error"
                        }</div>`;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error">Connection error: ${error.message}</div>`;
                }
            }

            async function uploadFile() {
                const fileInput = document.getElementById("fileInput");
                const resultDiv = document.getElementById("fileResult");

                if (!fileInput.files[0]) {
                    resultDiv.innerHTML = '<div class="error">Please select a file</div>';
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append("file", fileInput.files[0]);
                    formData.append("auto_create", "false");

                    const response = await fetch(`${API_BASE}/api/whatsapp/upload-chat`, {
                        method: "POST",
                        body: formData,
                    });

                    const data = await response.json();

                    if (response.ok) {
                        let html = '<div class="result">';
                        html += `<h3>âœ… Processed ${data.file_name}</h3>`;
                        html += `<p>Total extracted: ${data.total_extracted} deadlines</p>`;

                        data.deadlines.slice(0, 5).forEach((deadline) => {
                            html += `
                            <div style="border-left: 4px solid #28a745; padding-left: 15px; margin: 10px 0;">
                                <strong>ðŸ“… ${deadline.title}</strong><br>
                                Due: ${new Date(deadline.due_date).toLocaleString()}<br>
                                Priority: ${deadline.priority}, Confidence: ${(
                                deadline.confidence * 100
                            ).toFixed(0)}%<br>
                                <small>From: ${deadline.sender}</small>
                            </div>
                        `;
                        });

                        if (data.deadlines.length > 5) {
                            html += `<p><em>... and ${data.deadlines.length - 5} more</em></p>`;
                        }

                        html += "</div>";
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `<div class="error">Error: ${
                            data.detail || "Unknown error"
                        }</div>`;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error">Connection error: ${error.message}</div>`;
                }
            }

            async function loadExamples() {
                const resultDiv = document.getElementById("examplesResult");

                try {
                    const response = await fetch(`${API_BASE}/api/whatsapp/examples`);
                    const data = await response.json();

                    if (response.ok) {
                        let html = '<div class="result">';
                        html += "<h3>ðŸ“‹ Example Messages</h3>";

                        data.examples.forEach((example) => {
                            html += `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                <strong>Message:</strong> "${example.message}"<br>
                                <strong>Expected:</strong> ${example.expected_extraction.title} - ${example.expected_extraction.due_date}
                            </div>
                        `;
                        });

                        html += "<h4>ðŸ’¡ Tips:</h4><ul>";
                        data.tips.forEach((tip) => {
                            html += `<li>${tip}</li>`;
                        });
                        html += "</ul></div>";

                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `<div class="error">Error loading examples</div>`;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error">Connection error: ${error.message}</div>`;
                }
            }

            // Load examples on page load
            window.onload = () => {
                loadExamples();
            };
        </script>
    </body>
</html>
